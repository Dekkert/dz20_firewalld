# Lesson29 - Фильтрация трафика - firewalld, iptables

#Задание:

1. Реализовать knocking port
  centralRouter может попасть на ssh inetrRouter через knock скрипт
2. Добавить inetRouter2, который виден(маршрутизируется (host-only тип сети для виртуалки)) с хоста или форвардится порт через локалхост.
3. Запустить nginx на centralServer.
4. Пробросить 80й порт на inetRouter2 8080.
5. Дефолт в инет оставить через inetRouter.

Формат сдачи ДЗ - vagrant + ansible

#Выполнение:

Для решения использовались статьи:

https://wiki.archlinux.org/title/Port_knocking#Simple_port_knocking

https://otus.ru/nest/post/267/

листинг iptables  inetRouter
```
*nat
:PREROUTING ACCEPT [1:44]
:INPUT ACCEPT [1:44]
:OUTPUT ACCEPT [111:8672]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:TRAFFIC - [0:0]
:SSH-INPUT - [0:0]
:SSH-INPUTTWO - [0:0]

-A INPUT -p icmp --icmp-type 3 -j ACCEPT
-A INPUT -p icmp --icmp-type 8 -j ACCEPT
-A INPUT -p icmp --icmp-type 12 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 0 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 3 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 4 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 11 -j ACCEPT
-A OUTPUT -p icmp --icmp-type 12 -j ACCEPT

# TRAFFIC chain for Port Knocking. The correct port sequence in this example is  8881 -> 7777 -> 9991; any other sequence will drop the traffic
-A INPUT -j TRAFFIC
-A TRAFFIC -p icmp --icmp-type any -j ACCEPT
-A TRAFFIC -m state --state ESTABLISHED,RELATED -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 22 -m recent --rcheck --seconds 15 --name SSH2 -j ACCEPT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH2 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 9991 -m recent --rcheck --name SSH1 -j SSH-INPUTTWO
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH1 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 7777 -m recent --rcheck --name SSH0 -j SSH-INPUT
-A TRAFFIC -m state --state NEW -m tcp -p tcp -m recent --name SSH0 --remove -j DROP
-A TRAFFIC -m state --state NEW -m tcp -p tcp --dport 8881 -m recent --name SSH0 --set -j DROP
-A SSH-INPUT -m recent --name SSH1 --set -j DROP
-A SSH-INPUTTWO -m recent --name SSH2 --set -j DROP
-A TRAFFIC -j DROP
COMMIT
# END or further rules
```


листинг iptables  inetRouter2
```
*filter
:INPUT ACCEPT [222:17823]
:FORWARD ACCEPT [4:509]
:OUTPUT ACCEPT [160:14623]
-A FORWARD -d 192.168.0.2/32 -p tcp -m tcp --dport 80 -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
COMMIT
# Completed on Mon May  1 15:26:15 2023
# Generated by iptables-save v1.4.21 on Mon May  1 15:26:15 2023
*nat
:PREROUTING ACCEPT [3:472]
:INPUT ACCEPT [3:472]
:OUTPUT ACCEPT [80:6306]
:POSTROUTING ACCEPT [1:60]
-A PREROUTING -i eth2 -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.0.2:80
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
```
скрипт для knocking port

```
#!/bin/bash
HOST=$1
shift
for ARG in "$@"
do
        sudo nmap -Pn --max-retries 0 -p $ARG $HOST
done
```

1. Проверяем port knocking

```
[root@centralRouter ~]# /vagrant/knock_scr.sh 192.168.255.1 8881 7777 9991

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00074s latency).
PORT     STATE    SERVICE
8881/tcp filtered unknown
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.36 seconds

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00054s latency).
PORT     STATE    SERVICE
7777/tcp filtered cbt
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.34 seconds

Starting Nmap 6.40 ( http://nmap.org ) at 2023-05-01 18:03 UTC
Warning: 192.168.255.1 giving up on port because retransmission cap hit (0).
Nmap scan report for 192.168.255.1
Host is up (0.00051s latency).
PORT     STATE    SERVICE
9991/tcp filtered issa
MAC Address: 08:00:27:93:B2:D9 (Cadmus Computer Systems)

Nmap done: 1 IP address (1 host up) scanned in 0.35 seconds
```

2-4 Проверяю проброс до nginx с локалхоста 

```
root@ubuntu:~# curl 192.168.11.121:8080

Check mapping inetRouter2:8080 to centralServer:80 success!
```
3. Используем ansible-playbook

```
- name: ConfigcentralServer
  hosts: centralServer
  become: true

  tasks:





    - name: Enable EPEL Repository on CentOS 7
      yum:
       name: epel-release
       state: latest

    - name: install Services
      yum:
        name:
        - vim
        - iptables
        - tcpdump
        - net-tools
        - iptables-services
        - traceroute
        - nmap
        - nginx
        state: present
        update_cache: true


    - name: change config
      ansible.builtin.lineinfile:
       path: /usr/share/nginx/html/index.html
       line: 'Check mapping inetRouter2:8080 to centralServer:80 success!'

    - name: start nginx
      service:
        name: nginx
        state: started
        enabled: yes


    - name: disable default route
      ansible.builtin.lineinfile:
       path: /etc/sysconfig/network-scripts/ifcfg-eth0
       line: DEFROUTE=no

    - name: default route
      ansible.builtin.shell: |
        echo "GATEWAY=192.168.0.1" >> /etc/sysconfig/network-scripts/ifcfg-eth1
```
5. Проверяем что идём в интернет по дефолтному маршруту

```
[root@centralServer ~]# traceroute -I google.com
traceroute to google.com (108.177.14.101), 30 hops max, 60 byte packets
 1  gateway (192.168.0.1)  0.509 ms  0.462 ms  0.590 ms
 2  192.168.255.1 (192.168.255.1)  1.125 ms  1.210 ms  1.494 ms
 3  * * *
 4  * * *
 5  * * *
 6  gw.static.spd-mgts.ru (95.165.160.1)  7.285 ms  5.938 ms  6.135 ms
 7  mpts-ss-51.msk.mts-internet.net (212.188.1.6)  5.703 ms  4.649 ms  4.944 ms
 8  mag9-cr03-be12.51.msk.mts-internet.net (212.188.1.5)  5.309 ms * *
 9  * * *
10  * * *
11  a197-cr04-be31.77.msk.mts-internet.net (212.188.56.14)  6.855 ms  6.697 ms  6.662 ms
12  * * *
13  195.34.49.178 (195.34.49.178)  6.486 ms  6.455 ms  6.303 ms
14  a197-cr04-be18.10.msk.mts-internet.net (212.188.55.25)  8.134 ms  8.103 ms  7.833 ms
15  * * *
16  a197-cr01-po6.77.msk.mts-internet.net (195.34.59.14)  7.644 ms  7.608 ms  7.095 ms
17  195.34.59.12 (195.34.59.12)  6.201 ms  6.247 ms  6.766 ms
18  74.125.118.22 (74.125.118.22)  6.582 ms  7.212 ms  6.913 ms
19  108.170.250.129 (108.170.250.129)  7.779 ms  8.653 ms  8.149 ms
20  108.170.250.146 (108.170.250.146)  7.513 ms  7.161 ms  7.701 ms
21  209.85.249.158 (209.85.249.158)  22.922 ms  22.224 ms  22.180 ms
22  216.239.43.20 (216.239.43.20)  75.489 ms  75.458 ms  76.656 ms
23  142.250.56.217 (142.250.56.217)  24.796 ms  25.116 ms  24.861 ms
24  * * *ls -
25  * * *
26  * * *
27  * * *
28  * * *
29  * * *
30  * * *
```
